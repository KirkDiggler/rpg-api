#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit checks..."

# Check if we have any staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit"
    exit 0
fi

# Check specifically for Go files for some checks
STAGED_GO_FILES=$(echo "$STAGED_FILES" | grep '\.go$' || true)

echo -e "\n${YELLOW}Fixing EOF newlines...${NC}"
make fix-eof

# Only run Go-specific checks if Go files are staged
if [ -n "$STAGED_GO_FILES" ]; then
    echo -e "\n${YELLOW}Running formatter checks...${NC}"
    make fmt
    
    echo -e "\n${YELLOW}Checking go.mod files...${NC}"
    make tidy
    
    echo -e "\n${YELLOW}Running linter...${NC}"
    make lint
    
    echo -e "\n${YELLOW}Running tests...${NC}"
    make test
fi

# Check for proto files
STAGED_PROTO_FILES=$(echo "$STAGED_FILES" | grep '\.proto$' || true)
if [ -n "$STAGED_PROTO_FILES" ]; then
    echo -e "\n${YELLOW}Linting proto files...${NC}"
    make buf-lint
fi

# Check if any files were modified by formatting or go mod tidy
MODIFIED=$(git diff --name-only)
if [ -n "$MODIFIED" ]; then
    echo -e "\n${RED}‚ùå The following files were modified:${NC}"
    echo "$MODIFIED"
    echo -e "${YELLOW}Please stage these changes and commit again.${NC}"
    echo -e "${YELLOW}Run 'git add -u' to stage the changes.${NC}"
    exit 1
fi

echo -e "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}"